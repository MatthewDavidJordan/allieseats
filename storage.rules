rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // ── Helper: check if the authenticated user is an admin ──
    function isAdmin() {
      return request.auth != null
        && request.auth.token.email in [
          'mj1001571@gmail.com',  
          'mdj82@georgetown.edu',
          'allierstevens@icloud.com',
          'as4966@georgetown.edu'
        ];
    }

    // ── Review images ──
    // Path: reviews/{slug}/cover.{ext}
    // Path: reviews/{slug}/gallery/{file}
    // Public read (displayed on public site), admin-only upload
    match /reviews/{slug}/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin()
        && request.resource.size < 10 * 1024 * 1024           // max 10 MB
        && request.resource.contentType.matches('image/.*');    // images only
    }

    // ── List cover images ──
    // Path: lists/{slug}/cover.{ext}
    // Public read, admin-only upload
    match /lists/{slug}/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin()
        && request.resource.size < 10 * 1024 * 1024
        && request.resource.contentType.matches('image/.*');
    }

    // ── Site assets (profile image) ──
    // Path: site/profile.{ext}
    // Public read, admin-only upload
    match /site/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin()
        && request.resource.size < 10 * 1024 * 1024
        && request.resource.contentType.matches('image/.*');
    }

    // ── Beli uploads (screenshots & screen recordings) ──
    // Path: beli-uploads/{file}
    // Admin-only upload, public read (server fetches via download URL)
    match /beli-uploads/{file} {
      allow read: if true;
      allow write: if isAdmin()
        && request.resource.size < 100 * 1024 * 1024          // max 100 MB (videos)
        && (request.resource.contentType.matches('image/.*')
            || request.resource.contentType.matches('video/.*'));
    }

    // ── Default deny ──
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
